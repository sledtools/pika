#!/usr/bin/env bash
set -euo pipefail

# Ensure iOS tooling works even when `xcode-select -p` points at CommandLineTools or a Nix SDK.
ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
DEV_DIR="$("$ROOT/tools/xcode-dev-dir" 2>/dev/null || true)"
if [ -n "${DEV_DIR:-}" ]; then
  export DEVELOPER_DIR="$DEV_DIR"
fi

# agent-device runs a long-lived daemon under ~/.agent-device. If it was started previously
# under a different environment, it can keep failing even after DEVELOPER_DIR is fixed.
#
# IMPORTANT: Do NOT reset the daemon by default; we rely on sessions across commands
# for manual QA scripts (open -> snapshot/find/click/...).
#
# If you hit issues like "simctl not found" after changing Xcode installs, you can
# force a clean start:
#   PIKA_AGENT_DEVICE_CLEAN_DAEMON=1 ./tools/agent-device ...
if [ "${PIKA_AGENT_DEVICE_CLEAN_DAEMON:-0}" = "1" ]; then
  rm -f "$HOME/.agent-device/daemon.json" 2>/dev/null || true
fi

# Pin a known-good version (older globally-installed versions can be picked up by npx).
#
# Two pragmatic fixes:
# 1) Avoid Nix/direnv env vars breaking Xcode builds used by agent-device's iOS runner.
# 2) agent-device's bundled ios-runner project has, in some published builds, an invalid
#    deployment target (e.g. 26.0) which makes xcodebuild show only placeholder destinations.
#
# We keep this as a best-effort patch against npx's cached install.
version="agent-device@0.2.4"

# Ensure package is present in npx cache so we can patch it before real commands run.
npx --yes "$version" --help >/dev/null 2>&1 || true

for pbx in "$HOME/.npm/_npx"/*/node_modules/agent-device/ios-runner/AgentDeviceRunner/AgentDeviceRunner.xcodeproj/project.pbxproj; do
  if [ -f "$pbx" ] && rg -q "IPHONEOS_DEPLOYMENT_TARGET = 26\\.0;" "$pbx" 2>/dev/null; then
    perl -pi -e 's/\\bIPHONEOS_DEPLOYMENT_TARGET = 26\\.0;/IPHONEOS_DEPLOYMENT_TARGET = 17.0;/g' "$pbx" || true
  fi
done

exec env -u LD -u CC -u CXX npx --yes "$version" "$@"
