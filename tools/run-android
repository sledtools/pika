#!/usr/bin/env bash
set -euo pipefail

# One-command Android dev loop:
# - ensure emulator/device
# - build + install
# - launch app

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"

./tools/android-emulator-ensure

ADB="${ADB:-adb}"

pick_device() {
  "$ADB" devices 2>/dev/null | awk 'NR>1 && $2=="device" {print $1}' | head -n 1
}

SERIAL="$(pick_device || true)"
if [ -z "${SERIAL:-}" ]; then
  echo "error: no android device/emulator connected after ensure step" >&2
  "$ADB" devices >&2 || true
  exit 1
fi

# Build (via Gradle) then install deterministically onto the selected device.
just android-assemble

APK="$ROOT/android/app/build/outputs/apk/debug/app-debug.apk"
if [ ! -f "$APK" ]; then
  echo "error: expected apk not found: $APK" >&2
  exit 1
fi

"$ADB" -s "$SERIAL" install -r "$APK" >/dev/null

maybe_setup_adb_reverse() {
  # Optional host->emulator port wiring to mimic "app can reach localhost services":
  #   PIKA_ADB_REVERSE_PORTS="32820"               # device 32820 -> host 32820
  #   PIKA_ADB_REVERSE_PORTS="18080:32820,9090"   # device 18080 -> host 32820; device 9090 -> host 9090
  local ports="${PIKA_ADB_REVERSE_PORTS:-${PIKA_ADB_REVERSE:-}}"
  if [ -z "${ports:-}" ]; then
    return 0
  fi

  IFS=',' read -r -a items <<<"$ports"
  for item in "${items[@]}"; do
    item="$(echo "$item" | tr -d '[:space:]')"
    if [ -z "$item" ]; then
      continue
    fi
    local dev_port host_port
    if echo "$item" | grep -q ':'; then
      dev_port="${item%%:*}"
      host_port="${item##*:}"
    else
      dev_port="$item"
      host_port="$item"
    fi
    echo "adb reverse tcp:${dev_port} -> tcp:${host_port}"
    "$ADB" -s "$SERIAL" reverse "tcp:${dev_port}" "tcp:${host_port}" >/dev/null
  done
}

maybe_setup_adb_reverse

maybe_write_config() {
  # Optional dev-only relay override:
  #   PIKA_RELAY_URLS="ws://10.0.2.2:18080" just run-android
  # This writes `pika_config.json` into the app sandbox via `run-as` (debug builds only).
  local relays="${PIKA_RELAY_URLS:-${PIKA_RELAY_URL:-}}"
  if [ -z "${relays:-}" ]; then
    return 0
  fi

  # Comma-separated list -> JSON array.
  local json
  json="$(
    python3 - <<PY
import json
relays = "${relays}".strip()
items = [x.strip() for x in relays.split(",") if x.strip()]
print(json.dumps({"relay_urls": items, "key_package_relay_urls": items}))
PY
  )"

  echo "writing relay override to app config (pika_config.json)"
  "$ADB" -s "$SERIAL" shell am force-stop com.pika.app >/dev/null 2>&1 || true

  # Write via /data/local/tmp then copy into the app sandbox. This avoids fragile quoting and
  # ensures we write exactly `${filesDir}/pika_config.json` (Rust uses `data_dir/pika_config.json`,
  # and Android passes `context.filesDir` as `data_dir`).
  tmp_remote="/data/local/tmp/pika_config.json"
  printf '%s' "$json" | "$ADB" -s "$SERIAL" shell "cat > '$tmp_remote'"

  # Copy into the app's filesDir (debug builds allow `run-as`).
  #
  # Note: `run-as` does not reliably set `$HOME`; use absolute app paths instead.
  "$ADB" -s "$SERIAL" shell "run-as com.pika.app sh -c '
    set -e
    if cp \"${tmp_remote}\" /data/user/0/com.pika.app/files/pika_config.json 2>/dev/null; then
      cat /data/user/0/com.pika.app/files/pika_config.json >/dev/null
      exit 0
    fi
    if cp \"${tmp_remote}\" /data/data/com.pika.app/files/pika_config.json 2>/dev/null; then
      cat /data/data/com.pika.app/files/pika_config.json >/dev/null
      exit 0
    fi
    echo \"error: could not write app config via run-as\" >&2
    exit 1
  '"
}

maybe_write_config

echo "launching com.pika.app"
# Prefer `am start` with a resolved launcher activity (more reliable than monkey).
resolved="$("$ADB" -s "$SERIAL" shell cmd package resolve-activity --brief -a android.intent.action.MAIN -c android.intent.category.LAUNCHER com.pika.app 2>/dev/null | tr -d '\r' | tail -n 1 || true)"
if [ -n "${resolved:-}" ] && echo "$resolved" | grep -q '/'; then
  "$ADB" -s "$SERIAL" shell am start -W -n "$resolved" >/dev/null
else
  "$ADB" -s "$SERIAL" shell am start -W -a android.intent.action.MAIN -c android.intent.category.LAUNCHER -n com.pika.app/.MainActivity >/dev/null
fi

# Confirm the process is actually running, otherwise fail with useful diagnostics.
for i in $(seq 1 20); do
  if "$ADB" -s "$SERIAL" shell pidof com.pika.app >/dev/null 2>&1; then
    echo "ok: android app launched"
    exit 0
  fi
  sleep 0.5
done

echo "error: app did not appear to start (pidof com.pika.app empty)" >&2
"$ADB" -s "$SERIAL" shell cmd package resolve-activity --brief -a android.intent.action.MAIN -c android.intent.category.LAUNCHER com.pika.app 2>&1 | sed -n '1,80p' >&2 || true
exit 1
