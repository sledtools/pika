#!/usr/bin/env bash
set -euo pipefail

# One-command iOS dev loop (simulator or device).
#
# Default: simulator.
#   ./tools/run-ios
#
# Physical device:
#   ./tools/run-ios --device
#   PIKA_IOS_DEVICE_UDID=<udid> ./tools/run-ios --device
#
# Notes:
# - Must run inside `nix develop` (or via direnv) so the Rust toolchain has iOS targets.
# - Requires a full Xcode install under /Applications for `xcrun`, `simctl`, `devicectl`.
#
# Optional relay overrides:
#   PIKA_RELAY_URLS="wss://relay.primal.net,wss://nos.lol,wss://relay.damus.io" ./tools/run-ios
#   PIKA_KEY_PACKAGE_RELAY_URLS="wss://nostr-pub.wellorder.net,..." ./tools/run-ios
# Disable auto defaults:
#   PIKA_NO_RELAY_OVERRIDE=1 ./tools/run-ios

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$ROOT"

# If the user isn't in the devShell, re-exec under Nix for a consistent toolchain.
if [ -z "${IN_NIX_SHELL:-}" ] && [ "${PIKA_RUN_IOS_NO_NIX:-0}" != "1" ]; then
  qargs=()
  for a in "$@"; do qargs+=("$(printf '%q' "$a")"); done
  exec nix develop -c bash -lc "cd \"$ROOT\"; ./tools/run-ios ${qargs[*]}"
fi

IOS_BUNDLE_ID="${PIKA_IOS_BUNDLE_ID:-com.pika.app}"
IOS_TEAM_ID="${PIKA_IOS_DEVELOPMENT_TEAM:-}"
MODE="sim"
CONSOLE=0

usage() {
  cat <<EOF
usage: ./tools/run-ios [--sim|--device] [--console]

Env:
  PIKA_IOS_BUNDLE_ID        (default: $IOS_BUNDLE_ID)
  PIKA_IOS_DEVELOPMENT_TEAM (optional; recommended for --device)
  PIKA_IOS_DEVICE_UDID      (optional, for --device)
  PIKA_NO_RELAY_OVERRIDE=1  disable dev-friendly relay defaults
EOF
}

while [ $# -gt 0 ]; do
  case "$1" in
    --sim) MODE="sim" ;;
    --device) MODE="device" ;;
    --console) CONSOLE=1 ;;
    -h|--help) usage; exit 0 ;;
    *)
      echo "error: unknown arg: $1" >&2
      usage >&2
      exit 2
      ;;
  esac
  shift
done

default_relays() {
  echo "wss://relay.primal.net,wss://nos.lol,wss://relay.damus.io"
}

default_kp_relays() {
  echo "wss://nostr-pub.wellorder.net,wss://nostr-01.yakihonne.com,wss://nostr-02.yakihonne.com,wss://relay.satlantis.io"
}

effective_relays() {
  local relays="${PIKA_RELAY_URLS:-${PIKA_RELAY_URL:-}}"
  if [ -z "${relays:-}" ]; then relays="$(default_relays)"; fi
  echo "$relays"
}

effective_kp_relays() {
  local kp_relays="${PIKA_KEY_PACKAGE_RELAY_URLS:-${PIKA_KP_RELAY_URLS:-}}"
  if [ -z "${kp_relays:-}" ]; then kp_relays="$(default_kp_relays)"; fi
  echo "$kp_relays"
}

env_json_for_device() {
  if [ "${PIKA_NO_RELAY_OVERRIDE:-0}" = "1" ]; then
    # Empty dict.
    echo "{}"
    return 0
  fi
  local relays kp_relays
  relays="$(effective_relays)"
  kp_relays="$(effective_kp_relays)"
  python3 - <<PY
import json
print(json.dumps({
  "PIKA_RELAY_URLS": "${relays}",
  "PIKA_KEY_PACKAGE_RELAY_URLS": "${kp_relays}",
}))
PY
}

# Fail fast if iOS Simulator runtimes/devices are missing.
if [ "$MODE" = "device" ]; then
  DEV_DIR="$(ls -d /Applications/Xcode*.app/Contents/Developer 2>/dev/null | sort | tail -n 1 || true)"
  if [ -z "${DEV_DIR:-}" ]; then
    echo "error: Xcode not found under /Applications" >&2
    exit 1
  fi

  UDID="${PIKA_IOS_DEVICE_UDID:-}"
  if [ -z "${UDID:-}" ]; then
    UDID="$(
      # Avoid heredocs-in-command-substitution: macOS /bin/bash is 3.2 and can
      # mis-parse `<<'EOF'` in this context.
      DEVELOPER_DIR="$DEV_DIR" xcrun xctrace list devices 2>/dev/null | awk '
        $0 == "== Devices ==" { in_devices = 1; next }
        $0 == "== Simulators ==" { in_devices = 0; next }
        in_devices && !found && $0 ~ /iPhone/ {
          if (match($0, /\([0-9A-Fa-f-]{25,}\)[[:space:]]*$/)) {
            found = substr($0, RSTART + 1, RLENGTH - 2) # strip parens
          }
        }
        END { if (found) printf "%s", found }
      '
    )"
  fi
  if [ -z "${UDID:-}" ]; then
    echo "error: could not determine a connected iPhone UDID (set PIKA_IOS_DEVICE_UDID)" >&2
    exit 1
  fi

  # Build core xcframework + (re)generate the project.
  just ios-xcframework ios-xcodeproj

  # Build signed device .app (must unset LD/CC/CXX inside Nix shells).
  signing_settings=()
  signing_settings+=("PRODUCT_BUNDLE_IDENTIFIER=$IOS_BUNDLE_ID")
  if [ -n "${IOS_TEAM_ID:-}" ]; then
    signing_settings+=("DEVELOPMENT_TEAM=$IOS_TEAM_ID")
    signing_settings+=("CODE_SIGN_STYLE=Automatic")
  else
    echo "note: PIKA_IOS_DEVELOPMENT_TEAM not set; device signing may fail (set it to your Apple Team ID)" >&2
  fi

  env -u LD -u CC -u CXX DEVELOPER_DIR="$DEV_DIR" xcodebuild \
    -project ios/Pika.xcodeproj \
    -scheme Pika \
    -configuration Debug \
    -sdk iphoneos \
    -destination "id=$UDID" \
    -derivedDataPath ios/build-device \
    -allowProvisioningUpdates \
    "${signing_settings[@]}" \
    build

  app_path="ios/build-device/Build/Products/Debug-iphoneos/Pika.app"
  if [ ! -d "$app_path" ]; then
    echo "error: missing built app at $app_path" >&2
    exit 1
  fi

  echo "installing app to device: $UDID"
  DEVELOPER_DIR="$DEV_DIR" xcrun devicectl device install app -d "$UDID" "$app_path"

  env_json="$(env_json_for_device)"
  if [ "$CONSOLE" = "1" ]; then
    echo "launching $IOS_BUNDLE_ID (console attached)"
    DEVELOPER_DIR="$DEV_DIR" xcrun devicectl device process launch -d "$UDID" \
      --environment-variables "$env_json" \
      --terminate-existing \
      --console \
      "$IOS_BUNDLE_ID"
  else
    echo "launching $IOS_BUNDLE_ID"
    DEVELOPER_DIR="$DEV_DIR" xcrun devicectl device process launch -d "$UDID" \
      --environment-variables "$env_json" \
      --terminate-existing \
      "$IOS_BUNDLE_ID" >/dev/null
    echo "ok: ios app launched (device)"
  fi
  exit 0
fi

# Simulator mode.
udid="$(./tools/ios-sim-ensure | sed -n 's/^ok: ios simulator ready (udid=\(.*\))$/\1/p')"
if [ -z "${udid:-}" ]; then
  echo "error: could not determine simulator udid" >&2
  exit 1
fi

just ios-build-sim

app_path="ios/build/Debug-iphonesimulator/Pika.app"
if [ ! -d "$app_path" ]; then
  echo "error: missing built app at $app_path" >&2
  exit 1
fi

echo "installing app to simulator: $udid"
./tools/simctl install "$udid" "$app_path"

maybe_write_config() {
  # iOS passes `applicationSupportDirectory` as Rust `data_dir`, so we write:
  #   <app data container>/Library/Application Support/pika_config.json
  if [ "${PIKA_NO_RELAY_OVERRIDE:-0}" = "1" ]; then
    return 0
  fi

  local relays kp_relays
  relays="$(effective_relays)"
  kp_relays="$(effective_kp_relays)"

  local json
  json="$(
    python3 - <<PY
import json
relays = "${relays}".strip()
kp_relays = "${kp_relays}".strip()
relay_items = [x.strip() for x in relays.split(",") if x.strip()]
kp_items = [x.strip() for x in kp_relays.split(",") if x.strip()]
print(json.dumps({"disable_network": False, "relay_urls": relay_items, "key_package_relay_urls": kp_items}))
PY
  )"

  local container support_dir
  container="$(./tools/simctl get_app_container "$udid" "$IOS_BUNDLE_ID" data 2>/dev/null | tr -d '\r' | tail -n 1)"
  if [ -z "${container:-}" ] || [ ! -d "$container" ]; then
    echo "error: failed to locate simulator app container for $IOS_BUNDLE_ID (udid=$udid)" >&2
    exit 1
  fi

  support_dir="$container/Library/Application Support"
  mkdir -p "$support_dir"
  printf '%s' "$json" >"$support_dir/pika_config.json"
  echo "wrote relay override to: $support_dir/pika_config.json"
}

maybe_write_config

echo "launching $IOS_BUNDLE_ID"
./tools/simctl launch "$udid" "$IOS_BUNDLE_ID"

# Bring Simulator app to the foreground.
open -a Simulator >/dev/null 2>&1 || true

echo "ok: ios app launched (simulator)"
